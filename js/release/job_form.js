var JOBCENTRE=window.JOBCENTRE||{};JOBCENTRE.jobForm=(function(a){var h,c,n,e,o,g,k,l;var p={jobs:"/api/v1.1/jobs"};var m=Backbone.Model.extend({defaults:{ready:false,error:null}});var d=Backbone.Model.extend({draftKey:"draft_job",defaults:{title:"",referenceId:"",confidential:false,closeDate:"",autoRefresh:false,categories:[],memberStatuses:[],careerLevels:[],positionType:null,trainingPosition:false,locations:[],description:"",applicantRoutingType:{id:1},applicationEmail:"",applicationUrl:"",status:"active"},initialize:function(q,r){this.required=r.required;this.state=new m()},getCategoryIds:function(){return _.map(this.get("categories"),function(q){return parseInt(q.id,10)})},getMemberStatusIds:function(){return _.map(this.get("memberStatuses"),function(q){return parseInt(q.id,10)})},getCareerLevelIds:function(){return _.map(this.get("careerLevels"),function(q){return parseInt(q.id,10)})},getLocationDescription:function(q){if(q>=this.get("locations").length){return""}return this.get("locations")[q].description},getCloseDateOptions:function(){var t=!!this.get("activeDate")?moment.utc(this.get("activeDate")):moment.utc(o);var s=[];for(var r=1;r<=e;r++){var q=moment.utc(t).add(r,"days");s.push({value:q.format("YYYY-MM-DD"),label:q.format("MMMM D, YYYY"),})}return s},getCloseDate:function(){if(this.get("closeDate")){return this.get("closeDate")}else{return moment.utc(o).add(e,"days").format("YYYY-MM-DD")}},fetch:function(q){var r=this;this.state.set({ready:false,error:null});a.ajax({url:p.jobs+"/"+q,dataType:"json",cache:false,type:"GET",success:function(t,u,s){r.set(r.parse(t));r.state.set({ready:true,error:null})},error:function(u,v,t){var s=u.status===400?JSON.parse(u.responseText).message:"Error retrieving job.";r.state.set({error:s})}})},copyFrom:function(q){var r=this;this.state.set({ready:false,error:null});a.ajax({url:p.jobs+"/"+q,dataType:"json",cache:false,type:"GET",success:function(t,u,s){delete t.id;delete t.activeDate;delete t.publishDate;delete t.closeDate;t.status="active";r.set(r.parse(t));r.state.set({ready:true,error:null})},error:function(u,v,t){var s=u.status===400?JSON.parse(u.responseText).message:"Error retrieving job.";r.state.set({error:s})}})},validate:function(){var q=[];if(!this.get("title").trim()){q.push({name:"title",message:"Title is required."})}if(!this.get("categories").length){q.push({name:"categoryIds",message:g.jobCategory+" is required."})}if(!this.get("categories").length>3){q.push({name:"categoryIds",message:"Up to 3 "+g.jobCategories+" allowed."})}if(this.required.memberStatusId&&!this.get("memberStatuses").length){q.push({name:"memberStatusIds",message:"Member status is required."})}if(this.required.careerLevelId&&!this.get("careerLevels").length){q.push({name:"careerLevelIds",message:"Career level is required."})}if(!this.get("positionType")){q.push({name:"positionTypeId",message:"Position type is required."})}if(!this.get("locations").length){q.push({name:"location0",message:"Location is required."})}if(!this.get("description").trim()){q.push({name:"description",message:"Description is required."})}if(this.get("applicationEmail").trim()&&!/^[a-zA-Z0-9!#$%&'*+/=?^_`{|}~.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*$/.test(this.get("applicationEmail").trim())){q.push({name:"applicationEmail",message:"Email is invalid."})}if(this.get("applicationUrl").trim()&&!/^(http:\/\/|https:\/\/)[-a-zA-Z0-9+&@#\/%=~_|$?!:;,.\*\(\)]*[a-zA-Z0-9+&@#\/%=~\-_|$]$/.test(this.get("applicationUrl").trim())){q.push({name:"applicationUrl",message:"URL is invalid."})}if(this.get("applicantRoutingType").id==1&&!this.get("applicationEmail").trim()){q.push({name:"applicationEmail",message:"Email is required."})}if(this.get("applicantRoutingType").id==2&&!this.get("applicationUrl").trim()){q.push({name:"applicationUrl",message:"URL is required."})}return q},submit:function(){var q=this;if(this.isNew()&&!_.some(l,function(r){return q.get("positionType").id==r})){checkCredits(_.bind(this.save,this))}else{this.save()}},save:function(){var s=this;this.state.set({ready:false,error:null});var q=this.isNew()?"POST":"PUT";var r=this.isNew()?p.jobs:p.jobs+"/"+this.get("id");a.ajax({url:r,data:JSON.stringify(this.toJSON()),contentType:"application/json",dataType:"json",cache:false,type:q,success:function(u,v,t){if(JOBCENTRE.capabilities.localStorage){localStorage.removeItem(s.draftKey)}h.set("isSavedToServer",true);window.location.href=String.format(k,u.id)},error:function(v,w,u){var t=v.status===400?JSON.parse(v.responseText).message:"Error saving job.";s.state.set({ready:true,error:null});JOBCENTRE.alertFloater.show({summary:t,isError:true})}})},restoreDraft:function(){if(!JOBCENTRE.capabilities.localStorage||!localStorage.getItem(this.draftKey)){return}var q;try{q=JSON.parse(localStorage.getItem(this.draftKey))}catch(r){return}if(!q.employer||q.employer.id!==c.id){return}delete q.employer;this.set(q)}});var i=Backbone.Model.extend({defaults:{isNew:false,isDraftSaved:false,isSavedToServer:false,},initialize:function(){this.setup()},setup:function(){}});var b=function(q){this.parent=null;this.children=[];Backbone.View.apply(this,[q])};_.extend(b.prototype,Backbone.View.prototype,{errorTemplate:_.template(a("#job_form_error").html()),loaderClass:"flex-loader flex-loader-inline",renderState:function(q){if(q.get("error")){a(this.el).html(this.errorTemplate({error:q.get("error")}));return true}if(!q.get("ready")){this.renderLoader(this.el);return true}return false},renderLoader:function(q){var r=document.createElement("div");r.className=this.loaderClass;a(q).empty().append(r)},addChildren:function(q){var r,s=this;if(_.isArray(q)){r=q}else{r=_.toArray(arguments)}_.each(r,function(t){s.children.push(t);t.parent=s});if(r.length===1){return r[0]}else{return r}},disposeChildren:function(q){if(!q){return}var s=this;var r=_.isArray(q)?q:_.toArray(arguments);_.each(r,function(t){t.dispose()})},disposeAllChildren:function(){var q=this.children.slice(0);_.each(q,function(r){r.dispose()})},dispose:function(){this.disposeAllChildren();this.remove();this._removeFromParent()},_removeFromParent:function(){if(this.parent){this.parent._removeChild(this)}},_removeChild:function(q){var r=_.indexOf(this.children,q);if(r!==-1){this.children.splice(r,1)}}});b.extend=Backbone.View.extend;var j=b.extend({template:_.template(a("#job_form_page").html()),render:function(){this.$el.html(this.template());this.$("[data-outlet=job]").append(this.addChildren(new f({model:this.options.job})).render().el);return this}});var f=b.extend({validatable:false,template:_.template(a("#job_form_job").html()),initialize:function(q){this.listenTo(this.model.state,"change",this.render)},events:{"submit form":"onSubmit","change form":"onChange","keyup form":"onKeyup"},onSubmit:function(q){q.preventDefault();this.validatable=true;this.model.set(this.getFormValues());if(this.isValid()){this.model.submit()}else{this.scrollToTopError()}},onChange:function(q){if(a(q.target).attr("name")==="applicantRoutingTypeId"){this.onApplicantRoutingChange()}this.validateIfReady();if(this.model.isNew()){this.saveDraft()}},onApplicantRoutingChange:function(){this.$("[data-applicant-routing-email]").toggle(this.$("[name=applicantRoutingTypeId]").val()==1);this.$("[data-applicant-routing-url]").toggle(this.$("[name=applicantRoutingTypeId]").val()==2)},saveDraft:function(){if(!JOBCENTRE.capabilities.localStorage){return}localStorage.setItem(this.model.draftKey,JSON.stringify(_.extend(this.getFormValues(),{employer:{id:c.id}})));h.set("isDraftSaved",true)},onKeyup:function(q){if(q.which===13){return}this.validateIfReady()},validateIfReady:function(){if(!this.validatable){return}this.model.set(this.getFormValues());this.isValid()},isValid:function(){this.$("[data-error]").removeAttr("data-error");this.$(".form-error").remove();var q=this.model.validate();if(!q.length){return true}var r=this;_.each(q,function(s){r.$('[name="'+s.name+'"]').attr("data-error","").after('<div class="form-error">'+s.message+"</div>")})},scrollToTopError:function(){var q=(window.pageYOffset!==undefined)?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;if(q>this.$("[data-error]").offset().top){window.scrollTo(0,this.$el.offset().top)}},getFormValues:function(){var r=this;var q={};this.$("input,textarea,select").each(function(){if(!this.name){return}if(this.disabled){return}if(this.type==="radio"&&!this.checked){return}if(this.type==="checkbox"&&!this.checked){return}q[this.name]=q[this.name]?q[this.name]+","+a(this).val():a(this).val()});this.formPreProcess(q);return q},formPreProcess:function(q){if(q.applicantRoutingTypeId==1){q.applicationUrl=""}if(q.applicantRoutingTypeId==2){q.applicationEmail=""}q.applicantRoutingType={id:q.applicantRoutingTypeId};delete q.applicantRoutingTypeId;q.categories=[];if(q.categoryIds){q.categories=_.map(_.isString(q.categoryIds)?q.categoryIds.split(","):q.categoryIds,function(s){return{id:s}})}delete q.categoryIds;if(q.memberStatusIds){q.memberStatuses=_.map(q.memberStatusIds.split(","),function(s){return{id:s}});delete q.memberStatusIds}if(q.careerLevelIds){q.careerLevels=_.map(q.careerLevelIds,function(s){return{id:s}});delete q.careerLevelIds}q.positionType={id:q.positionTypeId};delete q.positionTypeId;q.confidential=q.confidential==="1";q.autoRefresh=q.autoRefresh==="1";q.trainingPosition=q.trainingPosition==="1";q.locations=[];for(var r=0;r<3;r++){if(q["location"+r]){q.locations.push({description:q["location"+r]})}delete q["location"+r]}q.description=this.removeTinyMceComment(this.emptyIfNoTinyMceText(tinyMCE.activeEditor.getContent()))},bindSelect2:function(){this.$("select").select2()},bindTinyMCE:function(){var r="description";var s={validElements:[["a","href|target:_blank"],["strong/b"],["em/i"],["br"],["p"],["div"],["ul"],["ol"],["li"]],replacements:[["h1","strong"],["h2","strong"],["h3","strong"],["h4","strong"],["h5","strong"]]};var u=function(v){return _.map(v.validElements,function(w){if(w.length==1){return w}if(w.length==2){return String.format("{0}[{1}]",w[0],w[1])}throw new Error("Element length not supported.")}).join(",")};var q=function(w){var v=[];_.each(w.validElements,function(x){_.each(x[0].split("/"),function(y){v.push(String.format("<{0}>",y))})});return v.join("")};var t=function(G,y,E){var C="";var v=false;var D=[];var w=[];var x="";var A=0;var B="";var z="";var F=function(I,H,J){return J.split(I).join(H)};if(y){w=y.match(/([a-zA-Z0-9]+)/gi)}G+="";D=G.match(/(<\/?[\S][^>]*>)/gi);for(C in D){if(isNaN(C)){continue}z=D[C].toString();v=false;for(B in w){x=w[B];A=-1;if(A!=0){A=z.toLowerCase().indexOf("<"+x+">")}if(A!=0){A=z.toLowerCase().indexOf("<"+x+" ")}if(A!=0){A=z.toLowerCase().indexOf("</"+x)}if(A==0){v=true;break}}if(v){G=F(z,z.replace(/(data-.+?=".*?")|(data-.+?='.*?')|(data-[a-zA-Z0-9-]+)/g,""),G)}else{for(tags in E){if(z.toLowerCase().indexOf("<"+E[tags][0]+">")==0||z.toLowerCase().indexOf("<"+E[tags][0]+" ")==0){G=F(z,"<"+E[tags][1]+">",G);break}if(z.toLowerCase().indexOf("</"+E[tags][0])==0){G=F(z,"</"+E[tags][1]+">",G);break}}G=F(z,"",G)}}return G};tinyMCE.init({mode:"exact",elements:r,theme:"advanced",plugins:"paste",paste_text_sticky:true,setup:function(v){v.onInit.add(function(w){w.pasteAsPlainText=false});v.onChange.add(function(w,x){a("#"+r).change()})},paste_preprocess:function(w,v){v.content=t(v.content,q(s),s.replacements)},valid_elements:u(s),content_css:n,theme_advanced_buttons1:"bold,italic,separator,bullist,numlist,separator,undo,redo,separator,link,unlink",theme_advanced_buttons2:"",theme_advanced_buttons3:"",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom",theme_advanced_resizing:false})},removeTinyMceComment:function(q){return q.replace(/<\!--[\s\S]*?-->/g,"")},emptyIfNoTinyMceText:function(q){var r="";var s=document.createElement("div");s.innerHTML=q;if(!s.innerHTML){return""}r=s.textContent||s.innerText||"";r=r.replace(/\n/gi,"");r=r.replace(/\s/g,"");r=r.replace(/\t/g,"");if(r==""){return""}else{return q}},bindLocationsSuggests:function(){var r=this;var q=function(){for(var s=0;s<3;s++){r.$("input[name=location"+s+"]").each(function(){var t=this;a(this).jsonSuggest({url:"/api/v1.1/locations?pageSize=7",textPropertyName:"description",minCharacters:3,onSelect:function(){a(t).change()}})})}};if(!a.contains(document.documentElement,this.el)){setTimeout(q,10)}else{q()}},bindUrlFixer:function(){this.$("input[name=applicationUrl]").change(function(){var q=/^(https?|s?ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(##((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;var r=a(this).val().trim();if(q.test(r)){return}if(!q.test("http://"+r)){return}a(this).val("http://"+r)})},bindTrainingPositionDisplay:function(){var q=this;this.$("input[name=trainingPosition]").change(function(){if(a(this).val()==="1"){q.$("[data-info=trainingPosition]").slideDown()}else{q.$("[data-info=trainingPosition]").slideUp()}});this.$("[data-info=trainingPosition]").toggle(this.$("input[name=trainingPosition]:checked").val()==="1")},render:function(){if(this.renderState(this.model.state)){return this}this.$el.html(this.template(this.model));this.bindSelect2();this.bindTinyMCE();this.bindLocationsSuggests();this.bindUrlFixer();this.bindTrainingPositionDisplay();this.onApplicantRoutingChange();return this}});return{init:function(r){h=new i({isNew:!r.jobId});c=r.employer;n=r.tinyMceCssPath;e=r.jobPostDurationMax;o=r.today;g=r.labels;k=r.redirectOnSave;l=r.skipCreditCheckForTypeIds;var q=new d(null,{required:r.required});if(r.jobId){q.fetch(r.jobId)}else{if(r.copyFromJobId){q.copyFrom(r.copyFromJobId)}else{q.set("applicationEmail",r.employer.email);q.set("status","active");q.restoreDraft();q.state.set("ready",true)}}var s=new j({job:q});a("[data-outlet=job_form_page]").append(s.render().el)}}}(jQuery));