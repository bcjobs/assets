var JOBCENTRE=window.JOBCENTRE||{};JOBCENTRE.jobForm=(function(a){var c,m,j,e,n,g,i,k;var o=function(p){o={jobs:p+"jobs"}};var l=Backbone.Model.extend({defaults:{ready:false,error:null}});var d=Backbone.Model.extend({draftKey:"draft_job",defaults:{title:"",referenceId:"",confidential:false,closeDate:"",autoRefresh:false,categories:[],memberStatuses:[],careerLevels:[],positionType:null,trainingPosition:false,locations:[],description:"",applicantRoutingType:{id:1},applicationEmail:"",applicationUrl:"",status:"active"},initialize:function(p,q){this.required=q.required;this.state=new l()},getCategoryIds:function(){return _.map(this.get("categories"),function(p){return parseInt(p.id,10)})},getMemberStatusIds:function(){return _.map(this.get("memberStatuses"),function(p){return parseInt(p.id,10)})},getCareerLevelIds:function(){return _.map(this.get("careerLevels"),function(p){return parseInt(p.id,10)})},getLocationDescription:function(p){if(p>=this.get("locations").length){return""}return this.get("locations")[p].description},getCloseDateOptions:function(){var s=!!this.get("activeDate")?moment.utc(this.get("activeDate")):moment.utc(n);var r=[];for(var q=1;q<=e;q++){var p=moment.utc(s).add(q,"days");r.push({value:p.format("YYYY-MM-DD"),label:p.format("MMMM D, YYYY"),})}return r},getCloseDate:function(){if(this.get("closeDate")){return this.get("closeDate")}else{return moment.utc(n).add(e,"days").format("YYYY-MM-DD")}},fetch:function(p){var q=this;this.state.set({ready:false,error:null});a.ajax({url:o.jobs+"/"+p,dataType:"json",cache:false,type:"GET",success:function(s,t,r){q.set(q.parse(s));q.state.set({ready:true,error:null})},error:function(t,u,s){var r=t.status===400?JSON.parse(t.responseText).message:"Error retrieving job.";q.state.set({error:r})}})},copyFrom:function(p){var q=this;this.state.set({ready:false,error:null});a.ajax({url:o.jobs+"/"+p,dataType:"json",cache:false,type:"GET",success:function(s,t,r){delete s.id;delete s.activeDate;delete s.publishDate;delete s.closeDate;q.set(q.parse(s));q.state.set({ready:true,error:null})},error:function(t,u,s){var r=t.status===400?JSON.parse(t.responseText).message:"Error retrieving job.";q.state.set({error:r})}})},validate:function(){var p=[];if(!this.get("title").trim()){p.push({name:"title",message:"Title is required."})}if(!this.get("categories").length){p.push({name:"categoryIds",message:g.jobCategory+" is required."})}if(!this.get("categories").length>3){p.push({name:"categoryIds",message:"Up to 3 "+g.jobCategories+" allowed."})}if(this.required.memberStatusId&&!this.get("memberStatuses").length){p.push({name:"memberStatusIds",message:"Member status is required."})}if(this.required.careerLevelId&&!this.get("careerLevels").length){p.push({name:"careerLevelIds",message:"Career level is required."})}if(!this.get("positionType")){p.push({name:"positionTypeId",message:"Position type is required."})}if(!this.get("locations").length){p.push({name:"location0",message:"Location is required."})}if(!this.get("description").trim()){p.push({name:"description",message:"Description is required."})}if(this.get("applicationEmail").trim()&&!/^[a-zA-Z0-9!#$%&'*+/=?^_`{|}~.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*$/.test(this.get("applicationEmail").trim())){p.push({name:"applicationEmail",message:"Email is invalid."})}if(this.get("applicationUrl").trim()&&!/^(http:\/\/|https:\/\/)[-a-zA-Z0-9+&@#\/%=~_|$?!:;,.\*\(\)]*[a-zA-Z0-9+&@#\/%=~\-_|$]$/.test(this.get("applicationUrl").trim())){p.push({name:"applicationUrl",message:"URL is invalid."})}if(this.get("applicantRoutingType").id==1&&!this.get("applicationEmail").trim()){p.push({name:"applicationEmail",message:"Email is required."})}if(this.get("applicantRoutingType").id==2&&!this.get("applicationUrl").trim()){p.push({name:"applicationUrl",message:"URL is required."})}return p},submit:function(){var p=this;if(this.isNew()&&!_.some(k,function(q){return p.get("positionType").id==q})){checkCredits(_.bind(this.save,this))}else{this.save()}},save:function(){var r=this;this.state.set({ready:false,error:null});var p=this.isNew()?"POST":"PUT";var q=this.isNew()?o.jobs:o.jobs+"/"+this.get("id");a.ajax({url:q,data:JSON.stringify(this.toJSON()),contentType:"application/json",headers:{"JC-RenewIfStale":false},dataType:"json",cache:false,type:p,success:function(t,u,s){if(JOBCENTRE.capabilities.localStorage){localStorage.removeItem(r.draftKey)}window.location.href=String.format(i,t.id)},error:function(u,v,t){var s=u.status===400?JSON.parse(u.responseText).message:"Error saving job.";r.state.set({ready:true,error:null});JOBCENTRE.alertFloater.show({summary:s,isError:true})}})},restoreDraft:function(){if(!JOBCENTRE.capabilities.localStorage||!localStorage.getItem(this.draftKey)){return}var p;try{p=JSON.parse(localStorage.getItem(this.draftKey))}catch(q){return}if(!p.employer||p.employer.id!==c.id){return}delete p.employer;this.set(p)}});var b=function(p){this.parent=null;this.children=[];Backbone.View.apply(this,[p])};_.extend(b.prototype,Backbone.View.prototype,{errorTemplate:_.template(a("#job_form_error").html()),loaderClass:"flex-loader",renderState:function(p){if(p.get("error")){a(this.el).html(this.errorTemplate({error:p.get("error")}));return true}if(!p.get("ready")){this.renderLoader(this.el);return true}return false},renderLoader:function(p){var q=document.createElement("div");q.className=this.loaderClass;a(p).empty().append(q)},addChildren:function(p){var q,r=this;if(_.isArray(p)){q=p}else{q=_.toArray(arguments)}_.each(q,function(s){r.children.push(s);s.parent=r});if(q.length===1){return q[0]}else{return q}},disposeChildren:function(p){if(!p){return}var r=this;var q=_.isArray(p)?p:_.toArray(arguments);_.each(q,function(s){s.dispose()})},disposeAllChildren:function(){var p=this.children.slice(0);_.each(p,function(q){q.dispose()})},dispose:function(){this.disposeAllChildren();this.remove();this._removeFromParent()},_removeFromParent:function(){if(this.parent){this.parent._removeChild(this)}},_removeChild:function(p){var q=_.indexOf(this.children,p);if(q!==-1){this.children.splice(q,1)}}});b.extend=Backbone.View.extend;var h=b.extend({template:_.template(a("#job_form_page").html()),render:function(){this.$el.html(this.template());this.$("[data-outlet=job]").append(this.addChildren(new f({model:this.options.job})).render().el);return this}});var f=b.extend({validatable:false,template:_.template(a("#job_form_job").html()),initialize:function(p){this.listenTo(this.model.state,"change",this.render)},events:{"submit form":"onSubmit","change form":"onChange","keyup form":"onKeyup"},onSubmit:function(p){p.preventDefault();this.validatable=true;this.model.set(this.getFormValues());if(this.isValid()){this.model.submit()}else{this.scrollToTopError()}},onChange:function(){this.validateIfReady();if(this.model.isNew()){this.saveDraft()}},saveDraft:function(){if(!JOBCENTRE.capabilities.localStorage){return}localStorage.setItem(this.model.draftKey,JSON.stringify(_.extend(this.getFormValues(),{employer:{id:c.id}})))},onKeyup:function(p){if(p.which===13){return}this.validateIfReady()},validateIfReady:function(){if(!this.validatable){return}this.model.set(this.getFormValues());this.isValid()},isValid:function(){this.$("[data-error]").removeAttr("data-error");this.$(".form-error").remove();var p=this.model.validate();if(!p.length){return true}var q=this;_.each(p,function(r){q.$('[name="'+r.name+'"]').attr("data-error","").after('<div class="form-error">'+r.message+"</div>")})},scrollToTopError:function(){var p=(window.pageYOffset!==undefined)?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;if(p>this.$("[data-error]").offset().top){window.scrollTo(0,this.$el.offset().top)}},getFormValues:function(){var q=this;var p={};this.$("input,textarea,select").each(function(){if(this.disabled){return}if(this.type==="radio"&&!this.checked){return}if(this.type==="checkbox"&&!this.checked){return}p[this.name]=p[this.name]?p[this.name]+","+a(this).val():a(this).val()});this.formPreProcess(p);return p},formPreProcess:function(p){p.applicantRoutingType={id:p.applicantRoutingTypeId};delete p.applicantRoutingTypeId;p.categories=[];if(p.categoryIds){p.categories=_.map(_.isString(p.categoryIds)?p.categoryIds.split(","):p.categoryIds,function(r){return{id:r}})}delete p.categoryIds;if(p.memberStatusIds){p.memberStatuses=_.map(p.memberStatusIds.split(","),function(r){return{id:r}});delete p.memberStatusIds}if(p.careerLevelIds){p.careerLevels=_.map(p.careerLevelIds,function(r){return{id:r}});delete p.careerLevelIds}p.positionType={id:p.positionTypeId};delete p.positionTypeId;p.confidential=p.confidential==="1";p.trainingPosition=p.trainingPosition==="1";p.locations=[];for(var q=0;q<3;q++){if(p["location"+q]){p.locations.push({description:p["location"+q]})}delete p["location"+q]}p.description=this.removeTinyMceComment(this.emptyIfNoTinyMceText(tinyMCE.activeEditor.getContent()))},bindSelect2:function(){this.$("select").select2()},bindTinyeMCE:function(){var q="description";var r={validElements:[["a","href|target:_blank"],["strong/b"],["em/i"],["br"],["p"],["ul"],["ol"],["li"]],replacements:[["h1","strong"],["h2","strong"],["h3","strong"],["h4","strong"],["h5","strong"]]};var t=function(u){return _.map(u.validElements,function(v){if(v.length==1){return v}if(v.length==2){return String.format("{0}[{1}]",v[0],v[1])}throw new Error("Element length not supported.")}).join(",")};var p=function(v){var u=[];_.each(v.validElements,function(w){_.each(w[0].split("/"),function(x){u.push(String.format("<{0}>",x))})});return u.join("")};var s=function(F,x,D){var B="";var u=false;var C=[];var v=[];var w="";var z=0;var A="";var y="";var E=function(H,G,I){return I.split(H).join(G)};if(x){v=x.match(/([a-zA-Z0-9]+)/gi)}F+="";C=F.match(/(<\/?[\S][^>]*>)/gi);for(B in C){if(isNaN(B)){continue}y=C[B].toString();u=false;for(A in v){w=v[A];z=-1;if(z!=0){z=y.toLowerCase().indexOf("<"+w+">")}if(z!=0){z=y.toLowerCase().indexOf("<"+w+" ")}if(z!=0){z=y.toLowerCase().indexOf("</"+w)}if(z==0){u=true;break}}if(!u){for(tags in D){if(y.toLowerCase().indexOf("<"+D[tags][0]+">")==0||y.toLowerCase().indexOf("<"+D[tags][0]+" ")==0){F=E(y,"<"+D[tags][1]+">",F);break}if(y.toLowerCase().indexOf("</"+D[tags][0])==0){F=E(y,"</"+D[tags][1]+">",F);break}}F=E(y,"",F)}}return F};tinyMCE.init({mode:"exact",elements:q,theme:"advanced",plugins:"paste",paste_text_sticky:true,setup:function(u){u.onInit.add(function(v){v.pasteAsPlainText=false});u.onChange.add(function(v,w){a("#"+q).change()})},paste_preprocess:function(v,u){u.content=s(u.content,p(r),r.replacements)},valid_elements:t(r),content_css:m,theme_advanced_buttons1:"bold,italic,separator,bullist,numlist,separator,undo,redo,separator,link,unlink",theme_advanced_buttons2:"",theme_advanced_buttons3:"",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom",theme_advanced_resizing:false})},removeTinyMceComment:function(p){return p.replace(/<\!--[\s\S]*?-->/g,"")},emptyIfNoTinyMceText:function(p){var q="";var r=document.createElement("div");r.innerHTML=p;if(!r.innerHTML){return""}q=r.textContent||r.innerText||"";q=q.replace(/\n/gi,"");q=q.replace(/\s/g,"");q=q.replace(/\t/g,"");if(q==""){return""}else{return p}},bindLocationsSuggests:function(){var q=this;var p=function(){for(var r=0;r<3;r++){q.$("input[name=location"+r+"]").each(function(){var s=this;a(this).jsonSuggest({url:j+"locations?pageSize=7",textPropertyName:"description",minCharacters:3,onSelect:function(){a(s).change()}})})}};if(!a.contains(document.documentElement,this.el)){setTimeout(p,10)}else{p()}},bindUrlFixer:function(){this.$("input[name=applicationUrl]").change(function(){var p=/^(https?|s?ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(##((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;var q=a(this).val().trim();if(p.test(q)){return}if(!p.test("http://"+q)){return}a(this).val("http://"+q)})},bindTrainingPositionDisplay:function(){var p=this;this.$("input[name=trainingPosition]").change(function(){if(a(this).val()==="1"){p.$("[data-info=trainingPosition]").slideDown()}else{p.$("[data-info=trainingPosition]").slideUp()}});this.$("[data-info=trainingPosition]").toggle(this.$("input[name=trainingPosition]:checked").val()==="1")},render:function(){if(this.renderState(this.model.state)){return this}this.$el.html(this.template(this.model));this.bindSelect2();this.bindTinyeMCE();this.bindLocationsSuggests();this.bindUrlFixer();this.bindTrainingPositionDisplay();return this}});return{init:function(q){c=q.employer;m=q.tinyMceCssPath;j=q.restPath;e=q.jobPostDurationMax;n=q.today;g=q.labels;i=q.redirectOnSave;k=q.skipCreditCheckForTypeIds;o(q.restPath);var p=new d(null,{required:q.required});if(q.jobId){p.fetch(q.jobId)}else{if(q.copyFromJobId){p.copyFrom(q.copyFromJobId);p.set("status","active")}else{p.set("applicationEmail",q.employer.email);p.set("status","active");p.restoreDraft();p.state.set("ready",true)}}var r=new h({job:p});a("[data-outlet=page]").append(r.render().el);window.job=p}}}(jQuery));