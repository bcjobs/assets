var JOBCENTRE=window.JOBCENTRE||{};JOBCENTRE.jobForm=(function(a){var h,c,o,l,e,p,g,k,m;var q=function(r){q={jobs:r+"jobs"}};var n=Backbone.Model.extend({defaults:{ready:false,error:null}});var d=Backbone.Model.extend({draftKey:"draft_job",defaults:{title:"",referenceId:"",confidential:false,closeDate:"",autoRefresh:false,categories:[],memberStatuses:[],careerLevels:[],positionType:null,trainingPosition:false,locations:[],description:"",applicantRoutingType:{id:1},applicationEmail:"",applicationUrl:"",status:"active"},initialize:function(r,s){this.required=s.required;this.state=new n()},getCategoryIds:function(){return _.map(this.get("categories"),function(r){return parseInt(r.id,10)})},getMemberStatusIds:function(){return _.map(this.get("memberStatuses"),function(r){return parseInt(r.id,10)})},getCareerLevelIds:function(){return _.map(this.get("careerLevels"),function(r){return parseInt(r.id,10)})},getLocationDescription:function(r){if(r>=this.get("locations").length){return""}return this.get("locations")[r].description},getCloseDateOptions:function(){var u=!!this.get("activeDate")?moment.utc(this.get("activeDate")):moment.utc(p);var t=[];for(var s=1;s<=e;s++){var r=moment.utc(u).add(s,"days");t.push({value:r.format("YYYY-MM-DD"),label:r.format("MMMM D, YYYY"),})}return t},getCloseDate:function(){if(this.get("closeDate")){return this.get("closeDate")}else{return moment.utc(p).add(e,"days").format("YYYY-MM-DD")}},fetch:function(r){var s=this;this.state.set({ready:false,error:null});a.ajax({url:q.jobs+"/"+r,dataType:"json",cache:false,type:"GET",success:function(u,v,t){s.set(s.parse(u));s.state.set({ready:true,error:null})},error:function(v,w,u){var t=v.status===400?JSON.parse(v.responseText).message:"Error retrieving job.";s.state.set({error:t})}})},copyFrom:function(r){var s=this;this.state.set({ready:false,error:null});a.ajax({url:q.jobs+"/"+r,dataType:"json",cache:false,type:"GET",success:function(u,v,t){delete u.id;delete u.activeDate;delete u.publishDate;delete u.closeDate;u.status="active";s.set(s.parse(u));s.state.set({ready:true,error:null})},error:function(v,w,u){var t=v.status===400?JSON.parse(v.responseText).message:"Error retrieving job.";s.state.set({error:t})}})},validate:function(){var r=[];if(!this.get("title").trim()){r.push({name:"title",message:"Title is required."})}if(!this.get("categories").length){r.push({name:"categoryIds",message:g.jobCategory+" is required."})}if(!this.get("categories").length>3){r.push({name:"categoryIds",message:"Up to 3 "+g.jobCategories+" allowed."})}if(this.required.memberStatusId&&!this.get("memberStatuses").length){r.push({name:"memberStatusIds",message:"Member status is required."})}if(this.required.careerLevelId&&!this.get("careerLevels").length){r.push({name:"careerLevelIds",message:"Career level is required."})}if(!this.get("positionType")){r.push({name:"positionTypeId",message:"Position type is required."})}if(!this.get("locations").length){r.push({name:"location0",message:"Location is required."})}if(!this.get("description").trim()){r.push({name:"description",message:"Description is required."})}if(this.get("applicationEmail").trim()&&!/^[a-zA-Z0-9!#$%&'*+/=?^_`{|}~.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*$/.test(this.get("applicationEmail").trim())){r.push({name:"applicationEmail",message:"Email is invalid."})}if(this.get("applicationUrl").trim()&&!/^(http:\/\/|https:\/\/)[-a-zA-Z0-9+&@#\/%=~_|$?!:;,.\*\(\)]*[a-zA-Z0-9+&@#\/%=~\-_|$]$/.test(this.get("applicationUrl").trim())){r.push({name:"applicationUrl",message:"URL is invalid."})}if(this.get("applicantRoutingType").id==1&&!this.get("applicationEmail").trim()){r.push({name:"applicationEmail",message:"Email is required."})}if(this.get("applicantRoutingType").id==2&&!this.get("applicationUrl").trim()){r.push({name:"applicationUrl",message:"URL is required."})}return r},submit:function(){var r=this;if(this.isNew()&&!_.some(m,function(s){return r.get("positionType").id==s})){checkCredits(_.bind(this.save,this))}else{this.save()}},save:function(){var t=this;this.state.set({ready:false,error:null});var r=this.isNew()?"POST":"PUT";var s=this.isNew()?q.jobs:q.jobs+"/"+this.get("id");a.ajax({url:s,data:JSON.stringify(this.toJSON()),contentType:"application/json",headers:{"JC-RenewIfStale":false},dataType:"json",cache:false,type:r,success:function(v,w,u){if(JOBCENTRE.capabilities.localStorage){localStorage.removeItem(t.draftKey)}h.set("isSavedToServer",true);window.location.href=String.format(k,v.id)},error:function(w,x,v){var u=w.status===400?JSON.parse(w.responseText).message:"Error saving job.";t.state.set({ready:true,error:null});JOBCENTRE.alertFloater.show({summary:u,isError:true})}})},restoreDraft:function(){if(!JOBCENTRE.capabilities.localStorage||!localStorage.getItem(this.draftKey)){return}var r;try{r=JSON.parse(localStorage.getItem(this.draftKey))}catch(s){return}if(!r.employer||r.employer.id!==c.id){return}delete r.employer;this.set(r)}});var i=Backbone.Model.extend({defaults:{isNew:false,isDraftSaved:false,isSavedToServer:false,},initialize:function(){this.setup()},setup:function(){}});var b=function(r){this.parent=null;this.children=[];Backbone.View.apply(this,[r])};_.extend(b.prototype,Backbone.View.prototype,{errorTemplate:_.template(a("#job_form_error").html()),loaderClass:"flex-loader flex-loader-inline",renderState:function(r){if(r.get("error")){a(this.el).html(this.errorTemplate({error:r.get("error")}));return true}if(!r.get("ready")){this.renderLoader(this.el);return true}return false},renderLoader:function(r){var s=document.createElement("div");s.className=this.loaderClass;a(r).empty().append(s)},addChildren:function(r){var s,t=this;if(_.isArray(r)){s=r}else{s=_.toArray(arguments)}_.each(s,function(u){t.children.push(u);u.parent=t});if(s.length===1){return s[0]}else{return s}},disposeChildren:function(r){if(!r){return}var t=this;var s=_.isArray(r)?r:_.toArray(arguments);_.each(s,function(u){u.dispose()})},disposeAllChildren:function(){var r=this.children.slice(0);_.each(r,function(s){s.dispose()})},dispose:function(){this.disposeAllChildren();this.remove();this._removeFromParent()},_removeFromParent:function(){if(this.parent){this.parent._removeChild(this)}},_removeChild:function(r){var s=_.indexOf(this.children,r);if(s!==-1){this.children.splice(s,1)}}});b.extend=Backbone.View.extend;var j=b.extend({template:_.template(a("#job_form_page").html()),render:function(){this.$el.html(this.template());this.$("[data-outlet=job]").append(this.addChildren(new f({model:this.options.job})).render().el);return this}});var f=b.extend({validatable:false,template:_.template(a("#job_form_job").html()),initialize:function(r){this.listenTo(this.model.state,"change",this.render)},events:{"submit form":"onSubmit","change form":"onChange","keyup form":"onKeyup"},onSubmit:function(r){r.preventDefault();this.validatable=true;this.model.set(this.getFormValues());if(this.isValid()){this.model.submit()}else{this.scrollToTopError()}},onChange:function(r){if(a(r.target).attr("name")==="applicantRoutingTypeId"){this.onApplicantRoutingChange()}this.validateIfReady();if(this.model.isNew()){this.saveDraft()}},onApplicantRoutingChange:function(){this.$("[data-applicant-routing-email]").toggle(this.$("[name=applicantRoutingTypeId]").val()==1);this.$("[data-applicant-routing-url]").toggle(this.$("[name=applicantRoutingTypeId]").val()==2)},saveDraft:function(){if(!JOBCENTRE.capabilities.localStorage){return}localStorage.setItem(this.model.draftKey,JSON.stringify(_.extend(this.getFormValues(),{employer:{id:c.id}})));h.set("isDraftSaved",true)},onKeyup:function(r){if(r.which===13){return}this.validateIfReady()},validateIfReady:function(){if(!this.validatable){return}this.model.set(this.getFormValues());this.isValid()},isValid:function(){this.$("[data-error]").removeAttr("data-error");this.$(".form-error").remove();var r=this.model.validate();if(!r.length){return true}var s=this;_.each(r,function(t){s.$('[name="'+t.name+'"]').attr("data-error","").after('<div class="form-error">'+t.message+"</div>")})},scrollToTopError:function(){var r=(window.pageYOffset!==undefined)?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;if(r>this.$("[data-error]").offset().top){window.scrollTo(0,this.$el.offset().top)}},getFormValues:function(){var s=this;var r={};this.$("input,textarea,select").each(function(){if(!this.name){return}if(this.disabled){return}if(this.type==="radio"&&!this.checked){return}if(this.type==="checkbox"&&!this.checked){return}r[this.name]=r[this.name]?r[this.name]+","+a(this).val():a(this).val()});this.formPreProcess(r);return r},formPreProcess:function(r){if(r.applicantRoutingTypeId==1){r.applicationUrl=""}if(r.applicantRoutingTypeId==2){r.applicationEmail=""}r.applicantRoutingType={id:r.applicantRoutingTypeId};delete r.applicantRoutingTypeId;r.categories=[];if(r.categoryIds){r.categories=_.map(_.isString(r.categoryIds)?r.categoryIds.split(","):r.categoryIds,function(t){return{id:t}})}delete r.categoryIds;if(r.memberStatusIds){r.memberStatuses=_.map(r.memberStatusIds.split(","),function(t){return{id:t}});delete r.memberStatusIds}if(r.careerLevelIds){r.careerLevels=_.map(r.careerLevelIds,function(t){return{id:t}});delete r.careerLevelIds}r.positionType={id:r.positionTypeId};delete r.positionTypeId;r.confidential=r.confidential==="1";r.trainingPosition=r.trainingPosition==="1";r.locations=[];for(var s=0;s<3;s++){if(r["location"+s]){r.locations.push({description:r["location"+s]})}delete r["location"+s]}r.description=this.removeTinyMceComment(this.emptyIfNoTinyMceText(tinyMCE.activeEditor.getContent()))},bindSelect2:function(){this.$("select").select2()},bindTinyMCE:function(){var s="description";var t={validElements:[["a","href|target:_blank"],["strong/b"],["em/i"],["br"],["p"],["div"],["ul"],["ol"],["li"]],replacements:[["h1","strong"],["h2","strong"],["h3","strong"],["h4","strong"],["h5","strong"]]};var v=function(w){return _.map(w.validElements,function(x){if(x.length==1){return x}if(x.length==2){return String.format("{0}[{1}]",x[0],x[1])}throw new Error("Element length not supported.")}).join(",")};var r=function(x){var w=[];_.each(x.validElements,function(y){_.each(y[0].split("/"),function(z){w.push(String.format("<{0}>",z))})});return w.join("")};var u=function(H,z,F){var D="";var w=false;var E=[];var x=[];var y="";var B=0;var C="";var A="";var G=function(J,I,K){return K.split(J).join(I)};if(z){x=z.match(/([a-zA-Z0-9]+)/gi)}H+="";E=H.match(/(<\/?[\S][^>]*>)/gi);for(D in E){if(isNaN(D)){continue}A=E[D].toString();w=false;for(C in x){y=x[C];B=-1;if(B!=0){B=A.toLowerCase().indexOf("<"+y+">")}if(B!=0){B=A.toLowerCase().indexOf("<"+y+" ")}if(B!=0){B=A.toLowerCase().indexOf("</"+y)}if(B==0){w=true;break}}if(w){H=G(A,A.replace(/(data-.+?=".*?")|(data-.+?='.*?')|(data-[a-zA-Z0-9-]+)/g,""),H)}else{for(tags in F){if(A.toLowerCase().indexOf("<"+F[tags][0]+">")==0||A.toLowerCase().indexOf("<"+F[tags][0]+" ")==0){H=G(A,"<"+F[tags][1]+">",H);break}if(A.toLowerCase().indexOf("</"+F[tags][0])==0){H=G(A,"</"+F[tags][1]+">",H);break}}H=G(A,"",H)}}return H};tinyMCE.init({mode:"exact",elements:s,theme:"advanced",plugins:"paste",paste_text_sticky:true,setup:function(w){w.onInit.add(function(x){x.pasteAsPlainText=false});w.onChange.add(function(x,y){a("#"+s).change()})},paste_preprocess:function(x,w){w.content=u(w.content,r(t),t.replacements)},valid_elements:v(t),content_css:o,theme_advanced_buttons1:"bold,italic,separator,bullist,numlist,separator,undo,redo,separator,link,unlink",theme_advanced_buttons2:"",theme_advanced_buttons3:"",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"bottom",theme_advanced_resizing:false})},removeTinyMceComment:function(r){return r.replace(/<\!--[\s\S]*?-->/g,"")},emptyIfNoTinyMceText:function(r){var s="";var t=document.createElement("div");t.innerHTML=r;if(!t.innerHTML){return""}s=t.textContent||t.innerText||"";s=s.replace(/\n/gi,"");s=s.replace(/\s/g,"");s=s.replace(/\t/g,"");if(s==""){return""}else{return r}},bindLocationsSuggests:function(){var s=this;var r=function(){for(var t=0;t<3;t++){s.$("input[name=location"+t+"]").each(function(){var u=this;a(this).jsonSuggest({url:l+"locations?pageSize=7",textPropertyName:"description",minCharacters:3,onSelect:function(){a(u).change()}})})}};if(!a.contains(document.documentElement,this.el)){setTimeout(r,10)}else{r()}},bindUrlFixer:function(){this.$("input[name=applicationUrl]").change(function(){var r=/^(https?|s?ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(##((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;var s=a(this).val().trim();if(r.test(s)){return}if(!r.test("http://"+s)){return}a(this).val("http://"+s)})},bindTrainingPositionDisplay:function(){var r=this;this.$("input[name=trainingPosition]").change(function(){if(a(this).val()==="1"){r.$("[data-info=trainingPosition]").slideDown()}else{r.$("[data-info=trainingPosition]").slideUp()}});this.$("[data-info=trainingPosition]").toggle(this.$("input[name=trainingPosition]:checked").val()==="1")},render:function(){if(this.renderState(this.model.state)){return this}this.$el.html(this.template(this.model));this.bindSelect2();this.bindTinyMCE();this.bindLocationsSuggests();this.bindUrlFixer();this.bindTrainingPositionDisplay();this.onApplicantRoutingChange();return this}});return{init:function(s){h=new i({isNew:!s.jobId});c=s.employer;o=s.tinyMceCssPath;l=s.restPath;e=s.jobPostDurationMax;p=s.today;g=s.labels;k=s.redirectOnSave;m=s.skipCreditCheckForTypeIds;q(s.restPath);var r=new d(null,{required:s.required});if(s.jobId){r.fetch(s.jobId)}else{if(s.copyFromJobId){r.copyFrom(s.copyFromJobId)}else{r.set("applicationEmail",s.employer.email);r.set("status","active");r.restoreDraft();r.state.set("ready",true)}}var t=new j({job:r});a("[data-outlet=job_form_page]").append(t.render().el)}}}(jQuery));