var JOBCENTRE=window.JOBCENTRE||{};JOBCENTRE.purchase=(function(a){var F=function(G){F={purchases:G+"purchases",countries:G+"countries",provinces:G+"provinces?countryId=:id",taxcodes:G+"taxcodes"}};var e=Backbone.Model.extend({_validators:{required:function(J,G,K,H,I){if(!K||(K+"").trim()==""){I.push({attr:G,message:J.message||(" is required")})}},maxLength:function(J,G,K,H,I){if(!K||(K+"").trim()==""){return}if(K.trim().length>J.max){I.push({attr:G,message:J.message||String.format(" exceeds {0} characters",J.max)})}},regex:function(J,G,K,H,I){if(!K||(K+"").trim()==""){return}if(!J.pattern.test(K.trim())){I.push({attr:G,message:J.message||(" is invalid")})}},custom:function(J,G,L,H,I){if(!J.isValid){throw new Error("isValid missing for custom validation")}var K=J.isValid(J,G,L,H);if(K===true){return}if(K===false){I.push({attr:G,message:J.message});return}if(_.isString(K)){I.push({attr:G,message:K});return}throw new Error("validity not supported.")}},isValid:function(){if(!this.validations){return true}var H=[];for(var G in this.attributes){if(!this.validations[G]){continue}this.checkValidity(this.validations[G],this.attributes[G],G,H)}if(H.length>0){this.trigger("validation-error",this,H);return false}else{return true}},checkValidity:function(J,K,G,H){for(var I in J){if(!this._validators[I]&&K[I]!==undefined){K=K[I];J=J[I];G=G+"."+I;this.checkValidity(J,K,G,H);continue}if(!this._validators[I]){throw new Error("Validation "+I+" not supported.")}this._validators[I](J[I],G,K,this.attributes,H)}}});var B=Backbone.Model.extend({defaults:{ready:false,error:null}});var A=Backbone.Model.extend({defaults:{selectedNav:null}});var g=Backbone.Model.extend({collection:Backbone.Collection,listName:"",url:"",initialize:function(){this._loading=false;this._loaded=false;this._list=new this.collection()},getList:function(){if(!this._loaded){this._load()}return this._list},_load:function(){var G=this;if(!this._loading){this._list.state.set({ready:false,error:null});this._loading=true;var H=this.url;if(_.isFunction(H)){H=H.call(this)}a.ajax({url:H,dataType:"json",cache:true,type:"GET",success:function(J,K,I){G._list.reset(J.data);G._list.state.set({ready:true,error:null});G._loaded=true},error:function(J,K,I){G._list.state.set({error:String.format("Error retrieving {0} list.",G.listName)})},complete:function(I,J){G._loading=false}})}}});var i=Backbone.Model.extend({initialize:function(){this.provinceCache=new v(null,{countryId:this.id})}});var h=Backbone.Collection.extend({model:i,initialize:function(){this.state=new B()}});var j=g.extend({collection:h,listName:"country",url:function(){return F.countries},getCountries:function(){return this.getList()}});var u=Backbone.Model.extend({});var w=Backbone.Collection.extend({model:u,initialize:function(){this.state=new B()}});var v=g.extend({collection:w,listName:"province",url:function(){return F.provinces.replace(":id",this._countryId)},initialize:function(G,H){g.prototype.initialize.call(this,G,H);this._countryId=H.countryId},getProvinces:function(){return this.getList()}});var C=Backbone.Model.extend();var E=Backbone.Collection.extend({model:C,initialize:function(){this.state=new B()}});var D=g.extend({collection:E,primeTimer:0,listName:"taxcodes",url:function(){return F.taxcodes},getTaxCodes:function(){return this.getList()}});var k=e.extend({defaults:{holder:"",number:"",expiry:"",cvd:""},expiryMonth:function(){if(!this.get("expiry")){return""}if(this.get("expiry").length<2){return""}return this.get("expiry").substring(0,2)},expiryYear:function(){if(!this.get("expiry")){return""}if(this.get("expiry").length!==4){return""}return this.get("expiry").substring(2,4)},validations:{holder:{required:{}},number:{required:{},custom:{isValid:function(N,G,O,H){if(!O||O.trim()==""){return false}if(/[^0-9-]+/.test(O)){return false}var L=0,M=0,I=false;O=O.replace(/\D/g,"");for(var K=O.length-1;K>=0;K--){var J=O.charAt(K);var M=parseInt(J,10);if(I){if((M*=2)>9){M-=9}}L+=M;I=!I}return(L%10)==0},message:" is invalid"}},expiry:{required:{},regex:{pattern:/^[0-9]{4}$/,message:" is not complete"}},cvd:{required:{},regex:{pattern:/^[0-9]{3,4}$/}}}});var b=e.extend({defaults:{contact:"",email:"",phone:"",street:"",city:"",postalCode:"",province:{},country:{}},validations:{contact:{required:{},maxLength:{max:256}},email:{required:{},maxLength:{max:256},regex:{pattern:/^[a-zA-Z0-9!#$%&'*+/=?^_`{|}~.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*$/}},phone:{required:{},maxLength:{max:20},custom:{isValid:function(J,G,K,H){if(!K||K.trim()==""){return false}var I=K.replace(/[^0-9]/g,"");return I.length>=10},message:" must be at least 10 numbers"}},street:{required:{},maxLength:{max:128}},city:{required:{},maxLength:{max:128}},postalCode:{required:{},regex:{pattern:/(^[a-zA-Z][0-9][a-zA-Z]\s?[0-9][a-zA-Z][0-9]$)|(^[0-9]{5})$/}},province:{id:{required:{}}},country:{id:{required:{}}}}});var p=Backbone.Model.extend({discountedPrice:function(){if(this.get("discountRate")===0){return this.get("price")}return this.get("price")*(1-this.get("discountRate"))},discountedText:function(){if(this.discountedPrice()%1===0){return this.discountedPrice().toString()}else{return this.discountedPrice().toFixed(2)}},discountedDescription:function(){if(!this.get("recurrencePeriod")){return this.discountedText()}return this.discountedText()+" /"+this.get("recurrencePeriod")},priceText:function(){if(this.get("price")%1===0){return this.get("price").toString()}else{return this.get("price").toFixed(2)}}});var q=Backbone.Collection.extend({model:p,forJobs:function(){return this.filter(function(G){return G.get("type")==="job"})},forJobsLine1:function(){return _.filter(this.forJobs(),function(G){return G.get("line")===1})},forJobsLine2:function(){return _.filter(this.forJobs(),function(G){return G.get("line")===2})},forResumes:function(){return this.filter(function(G){return G.get("type")==="resume"})}});var m=Backbone.Model.extend({trackEcommerce:function(){if(!window.dataLayer){return}dataLayer.push({event:"transactionComplete",transactionId:this.id,transactionAffiliation:this.get("agent")?"Agent":"Employer",transactionTotal:this.get("subTotal"),transactionTax:this.get("tax"),transactionShipping:0,transactionProducts:[{sku:this.get("sku"),name:this.get("title"),category:this.productCategory(),price:this.get("subTotal"),quantity:1}]})},productCategory:function(){var H=this.get("sku").split("-");if(H.length!==6){return""}H.shift();H.shift();var G=H.join("-");if(/^1-[1-9]\d*-0-0$/.test(G)){return"Job Credits"}if(/^0-0-1-[1-9]\d*$/.test(G)){return"Resume Credits"}if(/^1-0-0-0$/.test(G)){return"Unlimited Job"}if(/^0-0-1-0$/.test(G)){return"Unlimited Resume"}if(/^1-0-1-\d+$/.test(G)){return"Unlimited Combo"}return"Undefined"}});var x=Backbone.Model.extend({defaults:{creditCard:new k(),address:new b(),"package":null,invoice:null},initialize:function(G,H){this.packages=new q(H.packages);this.taxCodes=new D().getTaxCodes()},trySetPackage:function(G){var H=this.packages.find(function(I){return I.id==G});if(!H){return false}this.set("package",H);return true},taxRate:function(){if(!this.taxCodes.state.get("ready")){return 0}var H=this;var G=this.taxCodes.find(function(I){if(!I.get("province")){return true}return I.get("province").id==H.get("address").get("province").id});if(!G){return 0}return G.get("rate")},taxAmount:function(){if(!this.get("package")){return 0}return this.taxRate()*this.get("package").discountedPrice()},taxAmountText:function(){if(this.taxAmount()%1===0){return this.taxAmount().toString()}else{return this.taxAmount().toFixed(2)}},taxAmountDescription:function(){if(!this.get("package")){return"-"}if(!this.get("package").get("recurrencePeriod")){return this.taxAmountText()}return this.taxAmountText()+" /"+this.get("package").get("recurrencePeriod")},total:function(){if(!this.get("package")){return 0}return this.taxAmount()+this.get("package").discountedPrice()},totalText:function(){if(this.total()%1===0){return this.total().toString()}else{return this.total().toFixed(2)}},totalDescription:function(){if(!this.get("package")){return"-"}if(!this.get("package").get("recurrencePeriod")){return this.totalText()}return this.totalText()+" /"+this.get("package").get("recurrencePeriod")},save:function(G){G||(G={});var H=this;a.ajax({url:F.purchases,contentType:"application/json",data:JSON.stringify(this.toJSON()),dataType:"json",type:"POST",success:function(J,K,I){H.set("invoice",new m(J));H.get("invoice").trackEcommerce();if(G.success){G.success(H,J)}},error:function(J,L,I){if(J.status===400){var K=JSON.parse(J.responseText);if(G.error){G.error(H,K.message);return}}if(G.error){G.error(H,"Error connecting to the server.")}}})}});var f=function(G){this.parent=null;this.children=[];Backbone.View.apply(this,[G])};_.extend(f.prototype,Backbone.View.prototype,{loaderTemplate:_.template(a("#purchase_loader").html()),errorTemplate:_.template(a("#purchase_error").html()),renderState:function(G){if(G.get("error")){a(this.el).html(this.errorTemplate({error:G.get("error")}));return true}if(!G.get("ready")){this.renderLoader(this.el);return true}return false},renderLoader:function(G){a(G).empty().html(this.loaderTemplate())},addChildren:function(G){var H,I=this;if(_.isArray(G)){H=G}else{H=_.toArray(arguments)}_.each(H,function(J){I.children.push(J);J.parent=I});if(H.length===1){return H[0]}else{return H}},disposeChildren:function(G){if(!G){return}var I=this;var H=_.isArray(G)?G:_.toArray(arguments);_.each(H,function(J){J.dispose()})},disposeAllChildren:function(){var G=this.children.slice(0);_.each(G,function(H){H.dispose()})},dispose:function(){this.disposeAllChildren();this.remove();this._removeFromParent()},_removeFromParent:function(){if(this.parent){this.parent._removeChild(this)}},_removeChild:function(G){var H=_.indexOf(this.children,G);if(H!==-1){this.children.splice(H,1)}}});f.extend=Backbone.View.extend;var d=function(G){f.apply(this,[G]);if(this.modelName){this.listenTo(this.model.get(this.modelName),"validation-error",this.onValidationError,this)}};_.extend(d.prototype,f.prototype,{_validatable:false,events:{submit:"onSubmit","keyup input,textarea":"onKeyup","change select,input":"onChange",validate:"validateIfReady"},hideSavingState:function(){this.$el.children().removeClass("invisible").end().find(".flex-loader-mini").remove()},showSavingState:function(){this.$el.children().addClass("invisible").end().prepend('<div class="flex-loader-mini"></div>')},onSaveSuccess:function(G,H){this.hideSavingState()},onSaveError:function(H,G){this.hideSavingState();this.$('[data-element="alert_danger_server"]').text(G).show()},onValidationError:function(L,J){var G=this.$('[data-element="alert_danger_server"]');G.html("");for(var K=J.length;K--;){var I=J[K];if(_.isString(I)){G.html(I).show()}else{var H=this.mapFromModel(I.attr);this.$('input[name="'+H+'"],textarea[name="'+H+'"],select[name="'+H+'"]').each(function(){if(this.tagName==="SELECT"){}else{a(this).addClass("error")}}).closest(".form-group").find(".form-error").html(I.message).show()}}},onSubmit:function(G){G.preventDefault();this._validatable=true;if(this.isValid()){this.save()}},save:function(){},mapToModel:function(){var K=this;var G={};var J=this.$("form").serializeArray();for(var H=0,I=J.length;H<I;H++){G[J[H].name]=J[H].value}this.formPreProcess(G);this.model.get(this.modelName).set(G)},mapFromModel:function(G){return G},isValid:function(){this.$(".error").removeClass("error");this.$('[data-element="alert_danger_server"]').hide();this.$(".form-error").hide();return this.model.get(this.modelName).isValid()},formPreProcess:function(G){},onKeyup:function(G){if(G.which===13){return}this.mapToModel();this.validateIfReady()},onChange:function(H){var G=a(H.currentTarget);if(G.attr("name")==="country.id"){this.onCountryChange()}this.mapToModel();this.validateIfReady()},validateIfReady:function(){if(this._validatable){this.isValid()}},bindSelect2:function(){var H=this;var G=function(){H.$("select").select2({allowClear:true})};if(!a.contains(document.documentElement,this.el)){setTimeout(G,10)}else{G()}}});d.extend=f.extend;var n=f.extend({template:_.template(a("#purchase_modal").html()),className:"modal fade",initialize:function(){this.navView=null;this.content=null},getDirection:function(G,H){if(H==null){return 0}if(G.position<H.position){return -1}if(G.position>H.position){return 1}return 0},slideOut:function(J,H){if(J==null){return}if(H===0){this.disposeChildren(J);return}var I=this,G=this.$("[data-outlet=panel]"),K=G.width();G.height(G.height());J.$el.stop(true).css({width:K+"px",position:"absolute"}).animate({left:K*-H},300,function(){I.disposeChildren(J)})},slideIn:function(J,H){if(H===0){this.$("[data-outlet=panel]").append(J.render().el);return}var G=this.$("[data-outlet=panel]").append(J.render().el);var L=G.width();var I=G.outerHeight()-G.height();var K=J.$el.outerHeight(true);J.trigger("sliding-in-started");J.$el.css({position:"absolute",width:L+"px",left:L*H}).animate({left:0},300,function(){J.$el.css({position:"static",width:"100%"});J.trigger("sliding-in-ended")});G.animate({height:K+I},300,function(){G.css("height","auto")})},renderPlansView:function(){this.renderPanel(new t({model:this.model}))},renderAddressView:function(){if(!this.model.get("package")){y.navigate("",true);return}this.renderPanel(new c({model:this.model,countries:this.options.countries}))},renderPaymentView:function(){if(!this.model.get("package")){y.navigate("",true);return}if(!this.model.get("address").isValid()){y.navigate("address",true);return}this.renderPanel(new s({model:this.model}))},renderFinishView:function(){if(!this.model.get("invoice")){y.navigate("",true);return}this.renderPanel(new l({model:this.model,session:this.options.session,callToActionLabel:this.options.callToActionLabel}))},renderPanel:function(H){var I=this.content;this.content=this.addChildren(H);var G=this.getDirection(this.content,I);this.slideOut(I,G);this.slideIn(this.content,G)},render:function(){this.$el.html(this.template());this.navView=this.addChildren(new o({session:this.options.session}));this.$("[data-outlet=nav]").append(this.navView.render().el);return this}});var o=f.extend({template:_.template(a("#purchase_nav").html()),className:"purchase_nav",initialize:function(){this.listenTo(this.options.session,"change:selectedNav",this.onNavChange)},events:{"click [data-render]":"onRenderClick"},onNavChange:function(){this.$(".active").removeClass("active");a("[data-render="+this.options.session.get("selectedNav")+"]").parent().addClass("active")},onRenderClick:function(G){G.preventDefault();y.navigate(a(G.currentTarget).data("render"),true)},render:function(){this.$el.html(this.template());return this}});var r=d.extend({render:function(){this.$el.html(this.template(this.model));return this}});var t=r.extend({position:1,template:_.template(a("#purchase_panel_plans").html()),className:"panel panel_plans",events:{"click [data-package]":"onPackageClick"},onPackageClick:function(G){G.preventDefault();if(this.model.trySetPackage(a(G.currentTarget).data("package"))){y.navigate("address",true)}}});var c=r.extend({position:2,modelName:"address",template:_.template(a("#purchase_panel_address").html()),className:"panel panel_address",initialize:function(G){this._currentProvinces=null;this.listenTo(G.countries.state,"change",this.render)},onCountryChange:function(){var I=this.$('select[name="country.id"]').val();if(I){var H=this.options.countries.get(I);var J=H.provinceCache.getProvinces();this._currentProvinces=J;if(!J.state.get("ready")){var G=this.$('select[name="province.id"]').closest('[data-element="province_input_section"]');if(G.find(".select2-container").length){G.append('<span data-element="loader" class="flex-loader-mini"></span>').find(".select2-container").css("visibility","hidden")}this.listenTo(J.state,"change",this.renderProvinces);return}this.renderProvinces(J.state)}},renderProvinces:function(I){if(this._currentProvinces.state!==I){return}var J=this;var G=this.$('select[name="province.id"]');G.closest('[data-element="province_input_section"]').find('[data-element="loader"]').remove().end().find(".select2-container").css("visibility","visible");if(I.get("error")){JOBCENTRE.alertFloater.show({summary:I.get("error"),isError:true,duration:5000});return}if(!I.get("ready")){throw new Error("Provinces not ready.")}var H=[];H.push('<option value=""></option>');this._currentProvinces.each(function(K){H.push(String.format('<option value="{0}"{1}>{2}</option>',K.id,(J.model.get("address").get("province").id==K.id)?' selected="selected"':"",K.get("name")))});G.html(H.join("")).trigger("change")},renderCountries:function(){var H=this,G=[];G.push('<option value=""></option>');this.options.countries.each(function(I){G.push(String.format('<option value="{0}"{1}>{2}</option>',I.id,(H.model.get("address").get("country").id==I.id)?' selected="selected"':"",I.get("name")))});this.$('select[name="country.id"]').html(G.join(""));this.onCountryChange()},formPreProcess:function(G){G.province={id:G["province.id"]};G.country={id:G["country.id"]};delete G["province.id"];delete G["country.id"]},save:function(G){y.navigate("payment",true)},render:function(){if(this.renderState(this.options.countries.state)){return this}this.$el.html(this.template(this.model));this.renderCountries();this.bindSelect2();return this}});var s=r.extend({position:3,modelName:"creditCard",template:_.template(a("#purchase_panel_payment").html()),className:"panel panel_payment",initialize:function(){this.listenTo(this.model.taxCodes.state,"change",this.render)},formPreProcess:function(G){if(G.expiryMonth&&G.expiryYear){G.expiry=G.expiryMonth.toString()+G.expiryYear.toString()}else{G.expiry=""}G.number=G.number.replace(/\s/g,"");delete G.expiryMonth;delete G.expiryYear},mapFromModel:function(G){if(G==="expiry"){return"expiryMonth"}return G},onSaveSuccess:function(G,H){this.hideSavingState();y.navigate("finish",true)},save:function(){this.showSavingState();this.model.save({success:_.bind(this.onSaveSuccess,this),error:_.bind(this.onSaveError,this)})},render:function(){if(this.renderState(this.model.taxCodes.state)){return this}this.$el.html(this.template(this.model));var G=this;setTimeout(function(){G.$("input").first().focus()},100);return this}});var l=r.extend({position:4,modelName:"invoice",template:_.template(a("#purchase_panel_final").html()),className:"panel panel_invoice",render:function(){this.$el.html(this.template({invoice:this.model.get("invoice"),callToActionLabel:this.options.callToActionLabel}));return this}});var y;var z=Backbone.Router.extend({routes:{"":"plans",address:"address",payment:"payment",finish:"finish"},initialize:function(G){y=this;this.options=G;this.started=false},startUp:function(){this.started=true;this.session=new A(null,this.options);this.purchase=new x(null,this.options);var G={};if(this.options.address){this.purchase.get("address").set(this.options.address)}this.modalView=new n({model:this.purchase,session:this.session,callToActionLabel:this.options.callToActionLabel,countries:new j().getCountries()});a("body").append(this.modalView.render().el);this.modalView.$el.modal({backdrop:"static",keyboard:false}).on("hidden.bs.modal",_.bind(this.tearDown,this));if(this.options.packageId){if(this.purchase.trySetPackage(this.options.packageId)){y.navigate("address");y.address();return}}y.navigate("");y.plans()},tearDown:function(){this.modalView.dispose();this.modalView=null;this.session=null;y=null;Backbone.history.stop();if(this.purchase.get("invoice")){if(this.options.onPurchaseComplete){this.options.onPurchaseComplete()}}},plans:function(){if(!this.started){return}this.session.set("selectedNav","");this.modalView.renderPlansView()},address:function(){if(!this.started){return}this.session.set("selectedNav","address");this.modalView.renderAddressView()},payment:function(){if(!this.started){return}this.session.set("selectedNav","payment");this.modalView.renderPaymentView()},finish:function(){if(!this.started){return}this.session.set("selectedNav","finish");this.modalView.renderFinishView()}});return{init:function(G){F(G.restPath);var H=new z(G);Backbone.history.start();H.startUp();this.init=function(I){if(I.address){delete I.address}var J=new z(I);Backbone.history.start();J.startUp()}}}}(jQuery));JOBCENTRE.ensurePackage=(function(a){var b=Backbone.View.extend({template:_.template(a("#purchase_spinner").html()),className:"overlay overlay-white overlay-fixed",render:function(){this.$el.html(this.template());return this}});return{initJob:function(c){this.showSpinner();c.isForJob=true;c.notValidPlan=_.bind(this.purchase,this);this.checkCredits(c)},showSpinner:function(){this.spinnerView=new b();a("body").append(this.spinnerView.render().el)},removeSpinner:function(){this.spinnerView.remove()},checkCredits:function(c){var d=this;a.ajax({url:"/services/RemoteServiceProxy.cfc?method=checkEmployerCredits&returnformat=json",dataType:"json",cache:false,type:"GET",success:function(f,g,e){d.removeSpinner();if(f.SUCCESS){if(c.isForJob){if(f.JOBPOST){if(c.onValidPlan){c.onValidPlan()}return}}else{if(f.RESUMEACCESS){if(c.onValidPlan){c.onValidPlan()}return}}}c.notValidPlan(c)},error:function(f,g,e){d.removeSpinner();alert("Error connecting to the server. Please try again.")}})},purchase:function(c){var d=this;c.onPurchaseComplete=function(){c.notValidPlan=d.noop;d.showSpinner();d.checkCredits(c)};JOBCENTRE.purchase.init(c)},noop:function(){}}}(jQuery));