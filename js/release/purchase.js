var JOBCENTRE=window.JOBCENTRE||{};JOBCENTRE.purchase=(function(a){var G=function(H){G={purchases:H+"purchases",countries:H+"countries",provinces:H+"provinces?countryId=:id",taxcodes:H+"taxcodes"}};var f=Backbone.Model.extend({_validators:{required:function(K,H,L,I,J){if(!L||(L+"").trim()==""){J.push({attr:H,message:K.message||(" is required")})}},maxLength:function(K,H,L,I,J){if(!L||(L+"").trim()==""){return}if(L.trim().length>K.max){J.push({attr:H,message:K.message||String.format(" exceeds {0} characters",K.max)})}},regex:function(K,H,L,I,J){if(!L||(L+"").trim()==""){return}if(!K.pattern.test(L.trim())){J.push({attr:H,message:K.message||(" is invalid")})}},custom:function(K,H,M,I,J){if(!K.isValid){throw new Error("isValid missing for custom validation")}var L=K.isValid(K,H,M,I);if(L===true){return}if(L===false){J.push({attr:H,message:K.message});return}if(_.isString(L)){J.push({attr:H,message:L});return}throw new Error("validity not supported.")}},isValid:function(){if(!this.validations){return true}var I=[];for(var H in this.attributes){if(!this.validations[H]){continue}this.checkValidity(this.validations[H],this.attributes[H],H,I)}if(I.length>0){this.trigger("validation-error",this,I);return false}else{return true}},checkValidity:function(K,L,H,I){for(var J in K){if(!this._validators[J]&&L[J]!==undefined){L=L[J];K=K[J];H=H+"."+J;this.checkValidity(K,L,H,I);continue}if(!this._validators[J]){throw new Error("Validation "+J+" not supported.")}this._validators[J](K[J],H,L,this.attributes,I)}}});var C=Backbone.Model.extend({defaults:{ready:false,error:null}});var B=Backbone.Model.extend({defaults:{selectedNav:null}});var h=Backbone.Model.extend({collection:Backbone.Collection,listName:"",url:"",initialize:function(){this._loading=false;this._loaded=false;this._list=new this.collection()},getList:function(){if(!this._loaded){this._load()}return this._list},_load:function(){var H=this;if(!this._loading){this._list.state.set({ready:false,error:null});this._loading=true;var I=this.url;if(_.isFunction(I)){I=I.call(this)}a.ajax({url:I,dataType:"json",cache:true,type:"GET",success:function(K,L,J){H._list.reset(K.data);H._list.state.set({ready:true,error:null});H._loaded=true},error:function(K,L,J){H._list.state.set({error:String.format("Error retrieving {0} list.",H.listName)})},complete:function(J,K){H._loading=false}})}}});var j=Backbone.Model.extend({initialize:function(){this.provinceCache=new w(null,{countryId:this.id})}});var i=Backbone.Collection.extend({model:j,initialize:function(){this.state=new C()}});var k=h.extend({collection:i,listName:"country",url:function(){return G.countries},getCountries:function(){return this.getList()}});var v=Backbone.Model.extend({});var x=Backbone.Collection.extend({model:v,initialize:function(){this.state=new C()}});var w=h.extend({collection:x,listName:"province",url:function(){return G.provinces.replace(":id",this._countryId)},initialize:function(H,I){h.prototype.initialize.call(this,H,I);this._countryId=I.countryId},getProvinces:function(){return this.getList()}});var D=Backbone.Model.extend();var F=Backbone.Collection.extend({model:D,initialize:function(){this.state=new C()}});var E=h.extend({collection:F,primeTimer:0,listName:"taxcodes",url:function(){return G.taxcodes},getTaxCodes:function(){return this.getList()}});var l=f.extend({defaults:{holder:"",number:"",expiry:"",cvd:""},expiryMonth:function(){if(!this.get("expiry")){return""}if(this.get("expiry").length<2){return""}return this.get("expiry").substring(0,2)},expiryYear:function(){if(!this.get("expiry")){return""}if(this.get("expiry").length!==4){return""}return this.get("expiry").substring(2,4)},validations:{holder:{required:{}},number:{required:{},custom:{isValid:function(O,H,P,I){if(!P||P.trim()==""){return false}if(/[^0-9-]+/.test(P)){return false}var M=0,N=0,J=false;P=P.replace(/\D/g,"");for(var L=P.length-1;L>=0;L--){var K=P.charAt(L);var N=parseInt(K,10);if(J){if((N*=2)>9){N-=9}}M+=N;J=!J}return(M%10)==0},message:" is invalid"}},expiry:{required:{},regex:{pattern:/^[0-9]{4}$/,message:" is not complete"}},cvd:{required:{},regex:{pattern:/^[0-9]{3,4}$/}}}});var c=f.extend({defaults:{contact:"",email:"",phone:"",street:"",city:"",postalCode:"",province:{},country:{}},validations:{contact:{required:{},maxLength:{max:256}},email:{required:{},maxLength:{max:256},regex:{pattern:/^[a-zA-Z0-9!#$%&'*+/=?^_`{|}~.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*$/}},phone:{required:{},maxLength:{max:20},custom:{isValid:function(K,H,L,I){if(!L||L.trim()==""){return false}var J=L.replace(/[^0-9]/g,"");return J.length>=10},message:" must be at least 10 numbers"}},street:{required:{},maxLength:{max:128}},city:{required:{},maxLength:{max:128}},postalCode:{required:{},regex:{pattern:/(^[a-zA-Z][0-9][a-zA-Z]\s?[0-9][a-zA-Z][0-9]$)|(^[0-9]{5})$/}},province:{id:{required:{}}},country:{id:{required:{}}}}});var q=Backbone.Model.extend({initialize:function(){this.addedOnTo=null},discountedPrice:function(){if(this.get("discountRate")===0){return this.get("price")}return this.get("price")*(1-this.get("discountRate"))},discountedText:function(){if(this.discountedPrice()%1===0){return this.discountedPrice().toString()}else{return this.discountedPrice().toFixed(2)}},discountedDescription:function(){if(!this.get("recurrencePeriod")){return this.discountedText()}return this.discountedText()+" /"+this.get("recurrencePeriod")},priceText:function(){if(this.get("price")%1===0){return this.get("price").toString()}else{return this.get("price").toFixed(2)}},getAddon:function(){var H=this;if(!this.get("addon")){return null}return this.collection.find(function(I){return I.id==H.get("addon").id})},getAddonPrompt:function(){if(!this.getAddon()){return null}var H=Math.ceil(this.getAddon().discountedPrice()-this.discountedPrice());return{line1:this.get("addon").prompt1,line2:this.get("addon").prompt2,line3:this.get("addon").prompt3.replace("{price}",H)}}});var r=Backbone.Collection.extend({model:q,forJobs:function(){return this.filter(function(H){return H.get("type")==="job"})},forJobsLine1:function(){return _.filter(this.forJobs(),function(H){return H.get("line")===1})},forJobsLine2:function(){return _.filter(this.forJobs(),function(H){return H.get("line")===2})},forResumes:function(){return this.filter(function(H){return H.get("type")==="resume"})}});var n=Backbone.Model.extend({trackEcommerce:function(){if(!window.dataLayer){return}dataLayer.push({event:"transactionComplete",transactionId:this.id,transactionAffiliation:this.get("agent")?"Agent":"Employer",transactionTotal:this.get("subTotal"),transactionTax:this.get("tax"),transactionShipping:0,transactionProducts:[{sku:this.get("sku"),name:this.get("title"),category:this.productCategory(),price:this.get("subTotal"),quantity:1}]})},productCategory:function(){var I=this.get("sku").split("-");if(I.length!==6){return""}I.shift();I.shift();var H=I.join("-");if(/^1-[1-9]\d*-0-0$/.test(H)){return"Job Credits"}if(/^0-0-1-[1-9]\d*$/.test(H)){return"Resume Credits"}if(/^1-0-0-0$/.test(H)){return"Unlimited Job"}if(/^0-0-1-0$/.test(H)){return"Unlimited Resume"}if(/^1-0-1-\d+$/.test(H)){return"Unlimited Combo"}return"Undefined"}});var y=Backbone.Model.extend({defaults:{creditCard:new l(),address:new c(),"package":null,invoice:null},initialize:function(H,I){this.packages=new r(I.packages);this.taxCodes=new E().getTaxCodes()},trySetPackage:function(H){var I=this.packages.find(function(J){return J.id==H});if(!I){return false}this.set("package",I);return true},switchToAddonFrom:function(I){var H=I.getAddon();H.addedOnTo=I;this.trySetPackage(H.id)},switchAwayFromAddon:function(H){if(this.get("package")===H){this.trySetPackage(H.addedOnTo.id)}},taxRate:function(){if(!this.taxCodes.state.get("ready")){return 0}var I=this;var H=this.taxCodes.find(function(J){if(!J.get("province")){return true}return J.get("province").id==I.get("address").get("province").id});if(!H){return 0}return H.get("rate")},taxAmount:function(){if(!this.get("package")){return 0}return this.taxRate()*this.get("package").discountedPrice()},taxAmountText:function(){if(this.taxAmount()%1===0){return this.taxAmount().toString()}else{return this.taxAmount().toFixed(2)}},taxAmountDescription:function(){if(!this.get("package")){return"-"}if(!this.get("package").get("recurrencePeriod")){return this.taxAmountText()}return this.taxAmountText()+" /"+this.get("package").get("recurrencePeriod")},total:function(){if(!this.get("package")){return 0}return this.taxAmount()+this.get("package").discountedPrice()},totalText:function(){if(this.total()%1===0){return this.total().toString()}else{return this.total().toFixed(2)}},totalDescription:function(){if(!this.get("package")){return"-"}if(!this.get("package").get("recurrencePeriod")){return this.totalText()}return this.totalText()+" /"+this.get("package").get("recurrencePeriod")},save:function(H){H||(H={});var I=this;a.ajax({url:G.purchases,contentType:"application/json",data:JSON.stringify(this.toJSON()),dataType:"json",type:"POST",success:function(K,L,J){I.set("invoice",new n(K));I.get("invoice").trackEcommerce();if(H.success){H.success(I,K)}},error:function(K,M,J){if(K.status===400){var L=JSON.parse(K.responseText);if(H.error){H.error(I,L.message);return}}if(H.error){H.error(I,"Error connecting to the server.")}}})}});var g=function(H){this.parent=null;this.children=[];Backbone.View.apply(this,[H])};_.extend(g.prototype,Backbone.View.prototype,{loaderTemplate:_.template(a("#purchase_loader").html()),errorTemplate:_.template(a("#purchase_error").html()),renderState:function(H){if(H.get("error")){a(this.el).html(this.errorTemplate({error:H.get("error")}));return true}if(!H.get("ready")){this.renderLoader(this.el);return true}return false},renderLoader:function(H){a(H).empty().html(this.loaderTemplate())},addChildren:function(H){var I,J=this;if(_.isArray(H)){I=H}else{I=_.toArray(arguments)}_.each(I,function(K){J.children.push(K);K.parent=J});if(I.length===1){return I[0]}else{return I}},disposeChildren:function(H){if(!H){return}var J=this;var I=_.isArray(H)?H:_.toArray(arguments);_.each(I,function(K){K.dispose()})},disposeAllChildren:function(){var H=this.children.slice(0);_.each(H,function(I){I.dispose()})},dispose:function(){this.disposeAllChildren();this.remove();this._removeFromParent()},_removeFromParent:function(){if(this.parent){this.parent._removeChild(this)}},_removeChild:function(H){var I=_.indexOf(this.children,H);if(I!==-1){this.children.splice(I,1)}}});g.extend=Backbone.View.extend;var e=function(H){g.apply(this,[H]);if(this.modelName){this.listenTo(this.model.get(this.modelName),"validation-error",this.onValidationError,this)}};_.extend(e.prototype,g.prototype,{_validatable:false,events:{submit:"onSubmit","keyup input,textarea":"onKeyup","change select,input":"onChange",validate:"validateIfReady"},hideSavingState:function(){this.$el.children().removeClass("invisible").end().find(".flex-loader-mini").remove()},showSavingState:function(){this.$el.children().addClass("invisible").end().prepend('<div class="flex-loader-mini"></div>')},onSaveSuccess:function(H,I){this.hideSavingState()},onSaveError:function(I,H){this.hideSavingState();this.$('[data-element="alert_danger_server"]').text(H).show()},onValidationError:function(M,K){var H=this.$('[data-element="alert_danger_server"]');H.html("");for(var L=K.length;L--;){var J=K[L];if(_.isString(J)){H.html(J).show()}else{var I=this.mapFromModel(J.attr);this.$('input[name="'+I+'"],textarea[name="'+I+'"],select[name="'+I+'"]').each(function(){if(this.tagName==="SELECT"){}else{a(this).addClass("error")}}).closest(".form-group").find(".form-error").html(J.message).show()}}},onSubmit:function(H){H.preventDefault();this._validatable=true;if(this.isValid()){this.save()}},save:function(){},mapToModel:function(){var L=this;var H={};var K=this.$("form").serializeArray();for(var I=0,J=K.length;I<J;I++){H[K[I].name]=K[I].value}this.formPreProcess(H);this.model.get(this.modelName).set(H)},mapFromModel:function(H){return H},isValid:function(){this.$(".error").removeClass("error");this.$('[data-element="alert_danger_server"]').hide();this.$(".form-error").hide();return this.model.get(this.modelName).isValid()},formPreProcess:function(H){},onKeyup:function(H){if(H.which===13){return}this.mapToModel();this.validateIfReady()},onChange:function(I){var H=a(I.currentTarget);if(H.attr("name")==="country.id"){this.onCountryChange()}this.mapToModel();this.validateIfReady()},validateIfReady:function(){if(this._validatable){this.isValid()}},bindSelect2:function(){var I=this;var H=function(){I.$("select").select2({allowClear:true})};if(!a.contains(document.documentElement,this.el)){setTimeout(H,10)}else{H()}}});e.extend=g.extend;var o=g.extend({template:_.template(a("#purchase_modal").html()),className:"modal fade",initialize:function(){this.navView=null;this.content=null},getDirection:function(H,I){if(I==null){return 0}if(H.position<I.position){return -1}if(H.position>I.position){return 1}return 0},slideOut:function(K,I){if(K==null){return}if(I===0){this.disposeChildren(K);return}var J=this,H=this.$("[data-outlet=panel]"),L=H.width();H.height(H.height());K.$el.stop(true).css({width:L+"px",position:"absolute"}).animate({left:L*-I},300,function(){J.disposeChildren(K)})},slideIn:function(K,I){if(I===0){this.$("[data-outlet=panel]").append(K.render().el);return}var H=this.$("[data-outlet=panel]").append(K.render().el);var M=H.width();var J=H.outerHeight()-H.height();var L=K.$el.outerHeight(true);K.trigger("sliding-in-started");K.$el.css({position:"absolute",width:M+"px",left:M*I}).animate({left:0},300,function(){K.$el.css({position:"static",width:"100%"});K.trigger("sliding-in-ended")});H.animate({height:L+J},300,function(){H.css("height","auto")})},renderPlansView:function(){this.renderPanel(new u({model:this.model}))},renderAddressView:function(){if(!this.model.get("package")){z.navigate("",true);return}this.renderPanel(new d({model:this.model,countries:this.options.countries}))},renderAddonView:function(){if(!this.model.get("package")){z.navigate("",true);return}if(!this.model.get("address").isValid()){z.navigate("address",true);return}var H=this.model.get("package").addedOnTo?this.model.get("package").addedOnTo:this.model.get("package");this.renderPanel(new b({model:{purchase:this.model,basePackage:H}}))},renderPaymentView:function(){if(!this.model.get("package")){z.navigate("",true);return}if(!this.model.get("address").isValid()){z.navigate("address",true);return}this.renderPanel(new t({model:this.model}))},renderFinishView:function(){if(!this.model.get("invoice")){z.navigate("",true);return}this.renderPanel(new m({model:this.model,session:this.options.session,callToActionLabel:this.options.callToActionLabel}))},renderPanel:function(I){var J=this.content;this.content=this.addChildren(I);var H=this.getDirection(this.content,J);this.slideOut(J,H);this.slideIn(this.content,H)},render:function(){this.$el.html(this.template());this.navView=this.addChildren(new p({session:this.options.session}));this.$("[data-outlet=nav]").append(this.navView.render().el);return this}});var p=g.extend({template:_.template(a("#purchase_nav").html()),className:"purchase_nav",initialize:function(){this.listenTo(this.options.session,"change:selectedNav",this.onNavChange)},events:{"click [data-render]":"onRenderClick"},onNavChange:function(){this.$(".active").removeClass("active");a("[data-render="+this.options.session.get("selectedNav")+"]").parent().addClass("active")},onRenderClick:function(H){H.preventDefault();z.navigate(a(H.currentTarget).data("render"),true)},render:function(){this.$el.html(this.template());return this}});var s=e.extend({render:function(){this.$el.html(this.template(this.model));return this}});var u=s.extend({position:1,template:_.template(a("#purchase_panel_plans").html()),className:"panel panel_plans",events:{"click [data-package]":"onPackageClick"},onPackageClick:function(H){H.preventDefault();if(this.model.trySetPackage(a(H.currentTarget).data("package"))){z.navigate("address",true)}}});var d=s.extend({position:2,modelName:"address",template:_.template(a("#purchase_panel_address").html()),className:"panel panel_address",initialize:function(H){this._currentProvinces=null;this.listenTo(H.countries.state,"change",this.render)},onCountryChange:function(){var J=this.$('select[name="country.id"]').val();if(J){var I=this.options.countries.get(J);var K=I.provinceCache.getProvinces();this._currentProvinces=K;if(!K.state.get("ready")){var H=this.$('select[name="province.id"]').closest('[data-element="province_input_section"]');if(H.find(".select2-container").length){H.append('<span data-element="loader" class="flex-loader-mini"></span>').find(".select2-container").css("visibility","hidden")}this.listenTo(K.state,"change",this.renderProvinces);return}this.renderProvinces(K.state)}},renderProvinces:function(J){if(this._currentProvinces.state!==J){return}var K=this;var H=this.$('select[name="province.id"]');H.closest('[data-element="province_input_section"]').find('[data-element="loader"]').remove().end().find(".select2-container").css("visibility","visible");if(J.get("error")){JOBCENTRE.alertFloater.show({summary:J.get("error"),isError:true,duration:5000});return}if(!J.get("ready")){throw new Error("Provinces not ready.")}var I=[];I.push('<option value=""></option>');this._currentProvinces.each(function(L){I.push(String.format('<option value="{0}"{1}>{2}</option>',L.id,(K.model.get("address").get("province").id==L.id)?' selected="selected"':"",L.get("name")))});H.html(I.join("")).trigger("change")},renderCountries:function(){var I=this,H=[];H.push('<option value=""></option>');this.options.countries.each(function(J){H.push(String.format('<option value="{0}"{1}>{2}</option>',J.id,(I.model.get("address").get("country").id==J.id)?' selected="selected"':"",J.get("name")))});this.$('select[name="country.id"]').html(H.join(""));this.onCountryChange()},formPreProcess:function(H){H.province={id:H["province.id"]};H.country={id:H["country.id"]};delete H["province.id"];delete H["country.id"]},save:function(H){if(this.model.get("package").getAddon()){z.navigate("addon",true)}else{z.navigate("payment",true)}},render:function(){if(this.renderState(this.options.countries.state)){return this}this.$el.html(this.template(this.model));this.renderCountries();this.bindSelect2();return this}});var b=s.extend({position:3,template:_.template(a("#purchase_panel_addon").html()),className:"panel panel_addon",events:{"click [data-action]":"onActionClick"},onActionClick:function(H){H.preventDefault();if(a(H.currentTarget).data("action")==="add"){this.model.purchase.switchToAddonFrom(this.model.basePackage)}else{this.model.purchase.switchAwayFromAddon(this.model.basePackage.getAddon())}z.navigate("payment",true)}});var t=s.extend({position:4,modelName:"creditCard",template:_.template(a("#purchase_panel_payment").html()),className:"panel panel_payment",initialize:function(){this.listenTo(this.model.taxCodes.state,"change",this.render)},formPreProcess:function(H){if(H.expiryMonth&&H.expiryYear){H.expiry=H.expiryMonth.toString()+H.expiryYear.toString()}else{H.expiry=""}H.number=H.number.replace(/\s/g,"");delete H.expiryMonth;delete H.expiryYear},mapFromModel:function(H){if(H==="expiry"){return"expiryMonth"}return H},onSaveSuccess:function(H,I){this.hideSavingState();z.navigate("finish",true)},save:function(){this.showSavingState();this.model.save({success:_.bind(this.onSaveSuccess,this),error:_.bind(this.onSaveError,this)})},render:function(){if(this.renderState(this.model.taxCodes.state)){return this}this.$el.html(this.template(this.model));var H=this;setTimeout(function(){H.$("input").first().focus()},100);return this}});var m=s.extend({position:5,modelName:"invoice",template:_.template(a("#purchase_panel_final").html()),className:"panel panel_invoice",render:function(){this.$el.html(this.template({invoice:this.model.get("invoice"),callToActionLabel:this.options.callToActionLabel}));return this}});var z;var A=Backbone.Router.extend({routes:{"":"plans",address:"address",addon:"addon",payment:"payment",finish:"finish"},initialize:function(H){z=this;this.options=H;this.started=false},startUp:function(){this.started=true;this.session=new B(null,this.options);this.purchase=new y(null,this.options);var H={};if(this.options.address){this.purchase.get("address").set(this.options.address)}this.modalView=new o({model:this.purchase,session:this.session,callToActionLabel:this.options.callToActionLabel,countries:new k().getCountries()});a("body").append(this.modalView.render().el);this.modalView.$el.modal({backdrop:"static",keyboard:false}).on("hidden.bs.modal",_.bind(this.tearDown,this));if(this.options.packageId){if(this.purchase.trySetPackage(this.options.packageId)){z.navigate("address");z.address();return}}z.navigate("");z.plans()},tearDown:function(){this.modalView.dispose();this.modalView=null;this.session=null;z=null;Backbone.history.stop();if(this.purchase.get("invoice")){if(this.options.onPurchaseComplete){this.options.onPurchaseComplete()}}},plans:function(){if(!this.started){return}this.session.set("selectedNav","");this.modalView.renderPlansView()},addon:function(){if(!this.started){return}this.session.set("selectedNav","addon");this.modalView.renderAddonView()},address:function(){if(!this.started){return}this.session.set("selectedNav","address");this.modalView.renderAddressView()},payment:function(){if(!this.started){return}this.session.set("selectedNav","payment");this.modalView.renderPaymentView()},finish:function(){if(!this.started){return}this.session.set("selectedNav","finish");this.modalView.renderFinishView()}});return{init:function(H){G(H.restPath);var I=new A(H);Backbone.history.start();I.startUp();this.init=function(J){if(J.address){delete J.address}var K=new A(J);Backbone.history.start();K.startUp()}}}}(jQuery));JOBCENTRE.ensurePackage=(function(a){var b=Backbone.View.extend({template:_.template(a("#purchase_spinner").html()),className:"overlay overlay-white overlay-fixed",render:function(){this.$el.html(this.template());return this}});return{initJob:function(c){this.showSpinner();c.isForJob=true;c.notValidPlan=_.bind(this.purchase,this);this.checkCredits(c)},showSpinner:function(){this.spinnerView=new b();a("body").append(this.spinnerView.render().el)},removeSpinner:function(){this.spinnerView.remove()},checkCredits:function(c){var d=this;a.ajax({url:"/services/RemoteServiceProxy.cfc?method=checkEmployerCredits&returnformat=json",dataType:"json",cache:false,type:"GET",success:function(f,g,e){d.removeSpinner();if(f.SUCCESS){if(c.isForJob){if(f.JOBPOST){if(c.onValidPlan){c.onValidPlan()}return}}else{if(f.RESUMEACCESS){if(c.onValidPlan){c.onValidPlan()}return}}}c.notValidPlan(c)},error:function(f,g,e){d.removeSpinner();alert("Error connecting to the server. Please try again.")}})},purchase:function(c){var d=this;c.onPurchaseComplete=function(){c.notValidPlan=d.noop;d.showSpinner();d.checkCredits(c)};JOBCENTRE.purchase.init(c)},noop:function(){}}}(jQuery));